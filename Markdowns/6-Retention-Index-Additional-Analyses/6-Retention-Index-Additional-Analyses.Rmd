---
title: "Retention Index Additional Analyses"
author: "Degnan, David J. & Bramer, Lisa M. & Flores, Javier E."
date: "Last updated: 03/16/2023"
output:
  BiocStyle::html_document:
    toc_float: true
    code_folding: hide
    lib_dir: trelli
---

```{r Setup, include=FALSE}
path <- "~/Git_Repos/metabolomics_retention_index_score/Markdowns/6-Retention-Index-Additional-Analyses/"
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(rootdir = path)
library(dplyr)
library(data.table)
library(ggplot2)
library(patchwork)
library(e1071)
```

```{r Load Data}
# List FAMES files 
FAMES_files <- list.files("../../RI_Specific_Data/TP_RI_with_FAMES", full.names = T)

# Pull data from files 
FAMES_TP <- do.call(rbind, lapply(FAMES_files, function(x) {
  
  # Read data, add column indicating FAMEs or not, and add dataset name
  Sub <- fread(x) %>%
    mutate(
      FAMES = grepl("FAME", `Sample Name`),
      Dataset = strsplit(x, "/", fixed = T) %>% unlist() %>% tail(1)
    )
  
  # Split out fames 
  FAME_Sub <- Sub %>% filter(FAMES)
  Sub <- Sub %>% filter(!FAMES)
  
  # Add left and right difference
  Res <- Sub %>%
    mutate(
      `Left FAMEs RT` = lapply(`Retention Time`, function(RT) {
        ifelse(RT < min(FAME_Sub$`Retention Time`), NA, 
               FAME_Sub$`Retention Time`[which(RT - FAME_Sub$`Retention Time` > 0) %>% max()])
      }) %>% unlist(),
      `Left FAMEs RI` = lapply(`Retention Index`, function(RI) {
        ifelse(RI < min(FAME_Sub$`Retention Index`), NA, 
               FAME_Sub$`Retention Index`[which(RI - FAME_Sub$`Retention Index` > 0) %>% max()])
      }) %>% unlist(),
      `Left Difference` = `Retention Time` - `Left FAMEs RT`,
      `Right FAMEs RT` = lapply(`Retention Time`, function(RT) {
        ifelse(RT > max(FAME_Sub$`Retention Time`), NA, 
               FAME_Sub$`Retention Time`[which(FAME_Sub$`Retention Time` - RT > 0) %>% min()])
      }) %>% unlist(),
      `Right FAMEs RI` = lapply(`Retention Index`, function(RI) {
        ifelse(RI > max(FAME_Sub$`Retention Index`), NA, 
               FAME_Sub$`Retention Index`[which(FAME_Sub$`Retention Index` - RI > 0) %>% min()])
      }) %>% unlist(),
      `Right Difference` = `Right FAMEs RT` - `Retention Time`
    )
  
  return(Res)

}))

# Pull Skews
Skews <- FAMES_TP %>%
  dplyr::select(`Compound Name`, `Retention Index`) %>%
  group_by(`Compound Name`) %>%
  summarise(Skew = abs(skewness(`Retention Index`)))

# Merge skew
FAMES_TP <- merge(FAMES_TP, Skews, by = "Compound Name")

FAMES_TP <- FAMES_TP %>% mutate(`Max Difference` = lapply(1:nrow(FAMES_TP), function(el) {
  max(c(FAMES_TP$`Left Difference`[el], FAMES_TP$`Right Difference`[el]), na.rm = T)
}) %>% unlist())
```

## Are non-normal distributions far from FAMES?

```{r}
ggplot(FAMES_TP, aes(x = `Right Difference`, y = Skew)) + geom_point() + theme_bw() +
  facet_wrap(.~`Right FAMEs RI`)
```

```{r} 
(ggplot(FAMES_TP, aes(x = `Left Difference`, y = Skew)) + geom_point() + theme_bw()) + 
  (ggplot(FAMES_TP, aes(x = `Right Difference`, y = Skew)) + geom_point() + theme_bw())

ggplot(FAMES_TP, aes(x = `Max Difference`, y = Skew)) + geom_point() + theme_bw()
```

## How are retention indices selected? 

```{r}
Example <- fread("~/Downloads/Group 2_Standards.csv")

Example %>%
  filter(`Sample name` == "GCMS_FAMEs_01_GCMS02_20200303" & grepl("C8|C9|C10|C12|C14|C16|C18|C20|C22|C24|C26|C28", `Compound Name`)) %>%
  dplyr::select(`Compound Name`, `Retention Time`, `Retention index`, `Retention index Ref`)
```















